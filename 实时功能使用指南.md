·# 实时音频降噪功能测试与使用指南

## 1. 功能简介

`realtime.py` 实现了基于 DeepFilterNet 模型的实时音频降噪功能，使用 PyAudio 进行音频流处理。该功能可以实时捕获麦克风输入的音频，进行降噪处理后立即播放。

## 2. 依赖安装

在使用实时功能前，需要确保安装了以下依赖：

### 2.1 基础依赖

```bash
pip install numpy torch librosa soundfile
```

### 2.2 音频处理依赖

```bash
pip install pyaudio
```

**注意**：在 Windows 上安装 PyAudio 可能需要使用以下命令：

```bash
pip install pyaudio --use-pep517
```

或者从 [Python Extension Packages for Windows](https://www.lfd.uci.edu/~gohlke/pythonlibs/#pyaudio) 下载预编译的 wheel 文件安装。

## 3. 基本使用方法

### 3.1 直接运行（使用默认配置）

```bash
python realtime.py
```

这将使用默认配置运行实时降噪：
- 模型：`checkpoints/best1.pth`
- 采样率：48000 Hz
- 块大小：4800 样本（约 100 ms）
- 设备：自动选择（优先使用 CUDA，如可用）
- 输入/输出设备：默认音频设备

### 3.2 查看可用参数

```bash
python realtime.py --help
```

输出：
```
usage: realtime.py [-h] [--model MODEL] [--input_device INPUT_DEVICE] [--output_device OUTPUT_DEVICE] [--chunk_size CHUNK_SIZE] [--sample_rate SAMPLE_RATE] [--device DEVICE]

实时音频降噪

optional arguments:
  -h, --help            show this help message and exit
  --model MODEL         模型路径（可选，None表示创建新模型）
  --input_device INPUT_DEVICE
                        输入设备索引
  --output_device OUTPUT_DEVICE
                        输出设备索引
  --chunk_size CHUNK_SIZE
                        音频块大小（样本数，默认4800=100ms@48kHz）
  --sample_rate SAMPLE_RATE
                        采样率（默认48000Hz）
  --device DEVICE       设备（cuda/cpu，默认自动选择）
```

## 4. 详细操作流程

### 4.1 设备选择说明

realtime.py 程序现在具有智能设备选择功能，可以自动检测并选择最佳的音频设备：

- **设备列表显示**：程序启动时会自动显示所有可用的音频输入和输出设备
- **智能输出设备选择**：优先选择实际的物理音频设备（如扬声器、耳机），避免选择虚拟设备或系统映射器
- **设备选择顺序**：
  1. Realtek音频设备（如果有）
  2. 扬声器设备
  3. 耳机设备
  4. 其他输出设备

如果您需要手动指定设备，可以使用 `--input_device` 和 `--output_device` 参数：

```bash
# 查看可用设备列表
python realtime.py --list_devices

# 使用指定的输入和输出设备
python realtime.py --input_device 18 --output_device 16 --device cpu
```

### 4.2 启动前准备

1. **检查音频设备**：
   - 确保麦克风和扬声器已连接并正常工作
   - 调整系统音量到合适水平（建议 50-70%）
   - 关闭其他可能占用音频设备的应用程序

2. **准备测试音频**（可选）：
   - 可以使用 `test_audio` 目录下的测试文件（如 `op1.wav`, `op8.wav`）
   - 或准备自己的测试音频文件
   - 确保测试音频包含明显的噪声以便观察降噪效果

### 4.2 启动实时处理

1. 打开命令行终端，导航到项目目录：
   ```bash
   cd e:/Python/project/audio_noise
   ```

2. 运行实时处理脚本：
   ```bash
   python realtime.py
   ```

3. 观察启动日志：
   ```
   DeepFilterNet模型加载完成，使用设备: cpu
   采样率: 48000 Hz
   FFT窗口: 512
   实时降噪器初始化完成
   采样率: 48000 Hz
   块大小: 4800 样本 (100.0 ms)
   输入设备: 麦克风阵列 (Realtek(R) Audio)
   输出设备: 扬声器 (Realtek(R) Audio)
   开始实时处理... (按Ctrl+C停止)
   ```

4. 确认以下信息：
   - 模型成功加载
   - 选择的设备正确
   - 输入/输出设备符合预期
   - 实时处理已开始

### 4.3 实时处理中的操作

一旦看到 "开始实时处理... (按Ctrl+C停止)" 提示，实时降噪功能就已经启动并处于运行状态。

1. **进行音频测试**：
   
   - **方式一：直接说话**
     - 对着麦克风说话，观察降噪效果
     - 可以先保持安静，听背景噪声的处理效果
     - 然后说话，听人声与噪声的分离效果
     - 尝试不同的音量和说话距离
   
   - **方式二：播放测试音频**
     - 打开音频播放器（如 Windows Media Player、VLC 等）
     - 播放 `test_audio` 目录下的测试文件（如 `op1.wav`）
     - 将播放器音量调大，确保声音能被麦克风捕获
     - 观察降噪前后的音频质量差异

2. **观察性能指标**：
   - 程序会每 100 个音频块输出一次性能信息：
     ```
     处理速度: 45.2 帧/秒, 延迟: 100.0 ms
     ```
   - 确保处理速度稳定，没有明显的卡顿
   - 观察延迟是否在可接受范围内

3. **调整测试条件**（可选）：
   - 可以调整环境噪声（如开启/关闭风扇、空调等）
   - 测试不同类型的噪声（白噪声、说话声、背景音乐等）
   - 测试不同的音频内容（男声、女声、音乐等）

### 4.4 放完音频后的操作

1. **继续测试**（可选）：
   - 可以播放其他测试音频文件
   - 或继续直接说话测试
   - 尝试不同的测试条件，全面评估降噪效果

2. **暂停观察**：
   - 停止播放音频，保持安静
   - 听背景噪声的处理效果
   - 确认是否有残留噪声或异常声音

3. **记录测试结果**（可选）：
   - 记录不同测试条件下的降噪效果
   - 记录性能指标（处理速度、延迟）
   - 记录任何异常情况或问题

### 4.5 结束实时处理

当测试完成后，可以按以下步骤结束实时处理：

1. **停止实时处理**：
   - 在命令行终端中按 `Ctrl + C` 组合键
   - 程序会显示停止信息：
     ```
     停止处理...
     ```

2. **检查资源释放**：
   - 确认程序已正常退出
   - 检查 CPU/GPU 资源是否已释放
   - 确认音频设备已释放，可以被其他程序使用

3. **分析测试结果**：
   - 总结降噪效果是否符合预期
   - 分析性能指标是否满足需求
   - 确定是否需要调整参数或模型

### 4.6 后续操作

1. **调整参数重新测试**（可选）：
   - 如果降噪效果不理想，可以尝试调整参数：
     ```bash
     # 调整块大小
     python realtime.py --chunk_size 9600
     
     # 更换模型
     python realtime.py --model checkpoints/best2.pth
     
     # 调整采样率
     python realtime.py --sample_rate 24000
     ```

2. **使用其他功能**：
   - 如果需要批量处理音频文件，可以使用 `inference.py`：
     ```bash
     python inference.py --input_dir test_audio --output_dir denoised_audio
     ```
   - 如果需要评估模型性能，可以使用 `evaluate_model.py`：
     ```bash
     python evaluate_model.py --noisy test_audio/op1.wav
     ```

3. **保存测试记录**（可选）：
   - 可以将测试结果和观察记录保存到文档中
   - 记录使用的参数配置和测试条件
   - 为后续优化和改进提供参考

## 5. 测试方法

### 5.1 测试默认配置

1. 确保麦克风和扬声器正常工作
2. 运行 `python realtime.py`
3. 观察输出信息，确认设备选择正确
4. 说话或播放测试音频，听降噪效果
5. 按 `Ctrl+C` 停止

### 5.2 保存实时处理后的音频

```bash
# 保存处理后的音频到默认路径
python realtime.py --save_output

# 保存处理后的音频到指定路径
python realtime.py --save_output --output_path my_denoised_audio.wav
```

这将在实时处理时保存所有处理后的音频，并在停止时合并为一个完整的WAV文件。

### 5.3 查看和分析处理后的音频

1. **播放保存的音频**：
   ```bash
   # 使用系统默认播放器
   start denoised_output_20231201_143000.wav
   
   # 或使用Python播放
   pip install playsound
   python -c "from playsound import playsound; playsound('denoised_output_20231201_143000.wav')"
   ```

2. **可视化分析**：
   使用 `audio_info.py` 工具可视化原始音频和处理后音频的波形和频谱图：
   ```bash
   # 可视化原始音频
   python audio_info.py --audio_path test_audio/op1.wav
   
   # 可视化处理后的音频
   python audio_info.py --audio_path denoised_output_20231201_143000.wav
   ```

3. **比较原始音频和处理后音频**：
   ```bash
   # 使用inference.py对同一音频进行处理，用于对比
   python inference.py --input test_audio/op1.wav --output denoised_op1.wav
   
   # 然后分别播放两个文件进行对比
   ```

### 5.4 批量分析处理效果

```bash
# 创建目录用于保存结果
mkdir -p denoised_results

# 处理多个测试音频
for file in test_audio/*.wav; do
    python realtime.py --save_output --output_path denoised_results/$(basename $file) --chunk_size 9600
    # 注意：这会为每个文件启动一次实时处理，请手动按Ctrl+C停止
    # 或使用inference.py进行批量处理
    # python inference.py --input "$file" --output "denoised_results/$(basename $file)"
done
```

4. **使用专业工具分析**：
   - 可以使用Audacity等专业音频编辑软件打开保存的音频文件
   - 分析波形、频谱和频率响应
   - 进行降噪前后的详细对比

### 5.5 测试自定义配置

#### 5.5.1 指定设备

```bash
# 使用 CPU
python realtime.py --device cpu

# 使用 CUDA
python realtime.py --device cuda
```

#### 5.5.2 调整块大小

块大小影响延迟和处理性能：
- 较小的块大小：更低的延迟，但可能影响降噪质量
- 较大的块大小：更高的降噪质量，但延迟更大

```bash
# 使用 2400 样本（约 50 ms）
python realtime.py --chunk_size 2400

# 使用 9600 样本（约 200 ms）
python realtime.py --chunk_size 9600
```

#### 5.5.3 调整采样率

```bash
# 使用 24000 Hz 采样率
python realtime.py --sample_rate 24000
```

#### 5.5.4 选择音频设备

首先，查看系统中可用的音频设备：

```python
import pyaudio

p = pyaudio.PyAudio()
for i in range(p.get_device_count()):
    device_info = p.get_device_info_by_index(i)
    print(f"设备 {i}: {device_info['name']}")
    print(f"  输入通道数: {device_info['maxInputChannels']}")
    print(f"  输出通道数: {device_info['maxOutputChannels']}")
    print()
p.terminate()
```

然后，使用设备索引运行：

```bash
# 使用设备 1 作为输入，设备 2 作为输出
python realtime.py --input_device 1 --output_device 2
```

#### 5.5.5 使用不同模型

```bash
# 使用自定义模型
python realtime.py --model checkpoints/best2.pth
```

## 6. 性能监控

程序运行时会定期输出性能信息：

```
处理速度: 45.2 帧/秒, 延迟: 100.0 ms
```

- **处理速度**：每秒处理的音频块数量
- **延迟**：单个音频块的处理时间（ms）

## 7. 注意事项

1. **延迟问题**：实时音频处理不可避免会有一定延迟，这主要由 `chunk_size` 参数决定
2. **性能要求**：建议使用 GPU 加速（如果可用）以获得更好的性能
3. **设备兼容性**：某些音频设备可能不支持 48000 Hz 采样率，此时需要调整 `--sample_rate` 参数
4. **音频质量**：块大小和采样率会影响降噪质量，建议根据实际需求调整
5. **资源占用**：实时处理会占用一定的 CPU/GPU 资源，建议关闭其他占用资源的程序

## 8. 常见问题排查

### 8.1 PyAudio 安装失败

**问题**：安装 PyAudio 时出现错误

**解决方法**：
- 使用预编译的 wheel 文件：
  ```bash
  pip install https://files.pythonhosted.org/packages/ab/42/b4f04721c5c5bfc196ce156b3c768998ef8c0ae3654ed29ea5020c749a6b/PyAudio-0.2.11-cp38-cp38-win_amd64.whl
  ```
  （注意：根据 Python 版本和系统架构选择合适的 wheel 文件）

### 8.2 音频设备不可用

**问题**：无法打开音频设备

**解决方法**：
- 检查设备是否被其他程序占用
- 使用 `--input_device` 和 `--output_device` 参数指定正确的设备索引

### 8.3 处理速度慢

**问题**：处理速度低于预期，出现卡顿

**解决方法**：
- 使用 GPU 加速：`--device cuda`
- 增大块大小：`--chunk_size 9600`
- 降低采样率：`--sample_rate 24000`

### 8.4 降噪效果不佳

**问题**：降噪效果不理想

**解决方法**：
- 使用更好的模型：`--model checkpoints/best.pth`
- 增大块大小：`--chunk_size 9600`
- 确保使用合适的采样率：`--sample_rate 48000`

## 9. 高级功能

### 9.1 集成到其他应用

可以将 `RealtimeDenoiser` 类集成到其他应用中：

```python
from realtime import RealtimeDenoiser

# 创建降噪器实例
denoiser = RealtimeDenoiser(
    model_path="checkpoints/best1.pth",
    chunk_size=4800,
    sample_rate=48000,
    device="cuda"
)

# 启动实时处理
denoiser.start(input_device=0, output_device=1)
```

### 9.2 自定义处理逻辑

可以继承 `RealtimeDenoiser` 类，自定义处理逻辑：

```python
class CustomDenoiser(RealtimeDenoiser):
    def process_chunk(self, audio_chunk):
        # 自定义预处理
        processed_chunk = preprocess(audio_chunk)
        # 降噪处理
        clean_audio = super().process_chunk(processed_chunk)
        # 自定义后处理
        final_audio = postprocess(clean_audio)
        return final_audio

# 使用自定义降噪器
custom_denoiser = CustomDenoiser()
custom_denoiser.start()
```

## 10. 测试音频文件

测试时可以使用 `test_audio` 目录下的音频文件：

```bash
# 播放测试音频并观察降噪效果
python -m playsound test_audio/op1.wav
```

**注意**：需要安装 `playsound` 库：`pip install playsound`

## 11. 总结

实时音频降噪功能提供了一种便捷的方式来测试和使用 DeepFilterNet 模型的降噪效果。通过调整参数，可以平衡降噪质量、延迟和性能，满足不同场景的需求。在使用过程中，如遇到问题，可以参考本文档的常见问题排查部分进行解决。