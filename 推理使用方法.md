# 音频降噪模型推理使用方法

## 基本使用

```bash
python inference.py --input input.wav --output output.wav
```

## 参数说明

### 必要参数

| 参数 | 说明 | 示例 |
|------|------|------|
| `--input` | 输入音频文件路径（带噪音频） | `--input noisy.wav` |
| `--output` | 输出音频文件路径（降噪后音频） | `--output clean.wav` |

### 模型参数

| 参数 | 说明 | 默认值 | 可选值 |
|------|------|--------|--------|
| `--model` | 模型权重文件路径 | `checkpoints/best.pth` | 自定义模型路径 |
| `--device` | 运行设备 | 自动选择（优先CUDA） | `cuda`, `cpu` |
| `--sample_rate` | 模型处理采样率 | 48000 | 通常不需要修改 |

### AGC（自动增益控制）参数

| 参数 | 说明 | 默认值 | 调整建议 |
|------|------|--------|----------|
| `--no-agc` | 禁用自动增益控制 | 启用 | 当输入音频电平正常时可禁用 |
| `--agc_target_level` | AGC目标电平（dB） | -18.0 | 音量低→调小（如-24.0），音量高→调大（如-12.0） |
| `--agc_attack_time` | AGC攻击时间（秒） | 0.01 | 语音变化快→调小（如0.005），变化慢→调大（如0.05） |
| `--agc_release_time` | AGC释放时间（秒） | 0.1 | 环境噪声大→调小（如0.05），需要保持音量稳定→调大（如0.5） |
| `--noise_gate_threshold` | 噪声门限阈值（dB） | -40.0 | 背景噪声低→调小（如-50.0），背景噪声大→调大（如-30.0） |

### 评估参数

| 参数 | 说明 | 示例 |
|------|------|------|
| `--reference` | 参考音频路径（用于评估） | `--reference clean_reference.wav` |

## 高级使用示例

### 使用特定模型进行降噪
```bash
python inference.py --input noisy.wav --output clean.wav --model checkpoints/epoch_100.pth
```

### 强制使用CPU进行推理
```bash
python inference.py --input noisy.wav --output clean.wav --device cpu
```

### 禁用AGC并调整参数
```bash
python inference.py --input noisy.wav --output clean.wav --no-agc
```

### 使用自定义AGC参数
```bash
python inference.py --input noisy.wav --output clean.wav \
    --agc_target_level -20.0 \
    --agc_attack_time 0.005 \
    --agc_release_time 0.2 \
    --noise_gate_threshold -45.0
```

### 进行降噪并评估效果
```bash
python inference.py --input noisy.wav --output clean.wav --reference clean_reference.wav
```

## 评估指标说明

当提供参考音频时，脚本会计算并输出以下指标：

- **STOI**：短时客观可懂度（范围：0到1，值越高可懂度越好）
  - **调整建议**：
    - 无需额外安装依赖（已包含在pystoi中）
    - 对语音可懂度变化敏感
    - 适合评估噪声环境下的语音理解能力

- **SDR**：信号失真比（单位：dB，值越高表示信号质量越好）
  - **调整建议**：
    - 无需额外安装依赖
    - 对信号保真度敏感
    - 适合评估整体降噪效果

## 实际使用注意事项

1. **文件格式**：支持常见的音频格式（.wav, .mp3, .flac等），但推荐使用.wav格式以获得最佳效果
2. **采样率**：自动适应输入音频的采样率，无需手动调整
3. **模型选择**：推荐使用`checkpoints/best.pth`，这是训练过程中表现最好的模型
4. **设备选择**：默认自动选择GPU（如果可用），否则使用CPU

## 批处理建议

### 使用PowerShell进行批量处理
```powershell
# 批量处理目录下所有.wav文件
foreach ($file in Get-ChildItem "noisy_dir" -Filter *.wav) {
    $output = Join-Path "clean_dir" $file.Name
    python inference.py --input $file.FullName --output $output
}
```

### 使用Python脚本进行批量处理
```python
import os
import subprocess

input_dir = "noisy_dir"
output_dir = "clean_dir"

os.makedirs(output_dir, exist_ok=True)

for filename in os.listdir(input_dir):
    if filename.endswith(".wav"):
        input_path = os.path.join(input_dir, filename)
        output_path = os.path.join(output_dir, filename)
        command = f"python inference.py --input {input_path} --output {output_path}"
        subprocess.run(command, shell=True)
```

## 常见问题

1. **CUDA不可用**：检查PyTorch是否支持CUDA，可通过`python -c "import torch; print(torch.cuda.is_available())"`验证
2. **音频音量异常**：调整AGC参数，尤其是`--agc_target_level`和`--noise_gate_threshold`
3. **处理速度慢**：使用`--device cuda`（如可用）或减少输入音频的采样率